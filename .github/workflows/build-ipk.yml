sh -c '
set -e
TMP=/tmp/passwall-led-ipk
PKG=/tmp/passwall-led_1.0_all.ipk

rm -rf $TMP
mkdir -p $TMP/data/usr/bin $TMP/control

cat > $TMP/data/usr/bin/set_led_color.sh <<'"'"'EOF'"'"'
#!/bin/sh

LED_R="/sys/class/leds/LED0_Red/brightness"
LED_G="/sys/class/leds/LED0_Green/brightness"
LED_B="/sys/class/leds/LED0_Blue/brightness"

echo none > /sys/class/leds/LED0_Red/trigger 2>/dev/null
echo none > /sys/class/leds/LED0_Green/trigger 2>/dev/null
echo none > /sys/class/leds/LED0_Blue/trigger 2>/dev/null

echo 0 > "$LED_R"
echo 0 > "$LED_G"
echo 0 > "$LED_B"

case "$1" in
  red) echo 255 > "$LED_R" ;;
  green) echo 255 > "$LED_G" ;;
  yellow) echo 255 > "$LED_R"; echo 255 > "$LED_G" ;;
  off) ;;
esac
EOF

cat > $TMP/data/usr/bin/passwall_led_daemon.sh <<'"'"'EOF'"'"'
#!/bin/sh

LED="/usr/bin/set_led_color.sh"
STATE_FILE="/tmp/led_blink_state"

PING_WAN_IP="1.1.1.1"
PING_VPN_HOST="www.youtube.com"

SLEEP_BLINK=1
SLEEP_NORMAL=5

GOOD_MAX_MS=180
WARN_MAX_MS=350

blink_red() {
  if [ -f "$STATE_FILE" ]; then
    rm -f "$STATE_FILE"
    $LED off
  else
    touch "$STATE_FILE"
    $LED red
  fi
}

while true; do
  ping -c 1 -W 1 "$PING_WAN_IP" >/dev/null 2>&1 || { blink_red; sleep "$SLEEP_BLINK"; continue; }
  rm -f "$STATE_FILE"

  OUT_VPN="$(ping -c 1 -W 2 "$PING_VPN_HOST" 2>/dev/null)"
  echo "$OUT_VPN" | grep -q "1 packets transmitted, 1 packets received" || { $LED red; sleep "$SLEEP_NORMAL"; continue; }

  AVG_MS="$(echo "$OUT_VPN" | grep -E 'round-trip|rtt' | awk -F'/' '"'"'{print $5}'"'"' | sed '"'"'s/ ms//'"'"')"
  [ -z "$AVG_MS" ] && { $LED yellow; sleep "$SLEEP_NORMAL"; continue; }

  AVG_INT="$(printf "%.0f" "$AVG_MS")"
  [ "$AVG_INT" -le "$GOOD_MAX_MS" ] && $LED green || \
  [ "$AVG_INT" -le "$WARN_MAX_MS" ] && $LED yellow || $LED red

  sleep "$SLEEP_NORMAL"
done
EOF

chmod +x $TMP/data/usr/bin/*.sh

cat > $TMP/control/control <<EOF
Package: passwall-led
Version: 1.0
Architecture: all
Description: Google WiFi LED monitor for Passwall2
EOF

cat > $TMP/control/postinst <<EOF
#!/bin/sh
chmod +x /usr/bin/set_led_color.sh
chmod +x /usr/bin/passwall_led_daemon.sh
/usr/bin/passwall_led_daemon.sh >/dev/null 2>&1 &
exit 0
EOF

chmod +x $TMP/control/postinst
echo "2.0" > $TMP/debian-binary

tar czf $TMP/control.tar.gz -C $TMP/control .
tar czf $TMP/data.tar.gz -C $TMP/data .
tar czf $PKG -C $TMP debian-binary control.tar.gz data.tar.gz

echo "DONE: $PKG"
'
